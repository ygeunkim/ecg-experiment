---
title: "Causal Effect of Caffeine on Heart Rate"
subtitle: "using latin square design"
author: |
  | Young Geun Kim
  | [ygeunkim.github.io](https://ygeunkim.github.io)
  | 2019711358, [Department of Statistics](https://stat.skku.edu/stat/index.jsp)
date: "`r format(Sys.time(), '%d %b, %Y')`"
bibliography: "../docs/ecgref.bib"
biblio-style: "apalike"
link-citations: yes
abstract: |
  After drinking coffee, one's heartbeat raises. This kind of change in metabolism might be responsible for caffeine. To confirm this, we conduct an experiment. Blocked by coffe-to-water ratio and drinking speed, we build $4 \times 4$ latin square design with caffeine intensity factor. For each cell, we measure heart rate using ECG app installed in Apple Watch (it gives average BPM).
output: 
  bookdown::pdf_document2:
    toc: yes
    includes:
      in_header: "../docs/preamble.tex"
header-includes:
  - \usepackage{enumitem}
knit:
  (function(inputFile, encoding) {
    rmarkdown::render(input = inputFile, encoding = encoding, output_dir = "../static/report")
  })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  fig.pos = "H",
  fig.asp = .618
  )
knitr::knit_hooks$set(
  document = function(x) {
    sub("\\usepackage[]{color}", "\\usepackage{xcolor}", x, fixed = TRUE)
  }
)
options(digits = 3)
options(knitr.kable.NA = "")
options(kableExtra.latex.load_packages = FALSE)
is_html <- knitr::opts_knit$get("rmarkdown.pandoc.to") == "html"
is_latex <- knitr::opts_knit$get("rmarkdown.pandoc.to") == "latex"
kable_format <- ifelse(!is_html, "latex", "html")
kable_format <- ifelse(length(kable_format) == 0, "html", kable_format) # for excecutable
```

```{r pkgs, message=FALSE, echo=FALSE}
# tidyverse family---------------------
library(tidyverse)
# kable--------------------------------
library(knitr)
library(kableExtra)
# LSD randomization--------------------
library(magic)
# permutation--------------------------
library(combinat)
# parallelization----------------------
library(foreach)
# set seed for report -----------------
set.seed(1)
# functions----------------------------
source("lsd-anova.R")
source("lsd-rand.R")
```

\newpage

# Introduction {#intro}

We try to experiment whether caffeine affect ECG or heart rate

- Caffeine through coffee
- Average heart rate (BPM)

# Design of the Experiment {#design}

## Latin Square Design

```{r formdesign, include=FALSE}
# tibble------------------------
latin <- 
  tibble(
    row = rep(1:4, each = 4),
    col = rep(1:4, 4),
    trt = c(LETTERS[1:4], c("B", "C", "D", "A"), c("C", "D", "A", "B"), c("D", "A", "B", "A"))
  )
```

In this experiment, we implement reduced latin square design (LSD).

### Blocking factors

It is known that caffeine intake depends on coffee-to-water ratio and drinking speed [@naver2018]. So we set these two as row and column factors.

Coffee-to-water ratio is our row factor.

1. 1:0 (Espresso, 40 ml)
2. 1:2.5 (Water 100 ml)
3. 1:5 (Water 200 ml)
4. 1:7.5 (Water 300 ml)

Drinking-coffee-speed is our column speed.

1. <=5 sec
2. 5-15 sec
3. 15-30 sec
4. 30< sec

### Treatment

Denote that we are interested in caffeine. We took capsule, [Starbucks by Nespresso](https://athome.starbucks.com/coffees-by-format/nespresso-original/) [@reddit2020].

1. House blend: 74.5 mg
2. Sumatra: 54.5 mg
3. Decaf espresso roast: 3 mg
4. Just water: 0 mg

### Output and measurement

Using ECG app in Apple Watch series 4, we measure *Average heart rage (in BPM)*.
Since there exists variation, we consider difference of BPM after and before: $y_{rc}^{post} - y_{rc}^{pre}$

### Remarks

First we randomly allocate treatments (`1`, `2`, `3`, `4`) to (`A`, `B`, `C`, `D`).

```{r allocation, cache=TRUE}
set.seed(1)
sample(LETTERS[1:4])
```

i.e.

\begin{enumerate}[label=(\Alph*)]
  \item House blend (74.5 mg)
  \item Water (0 mg)
  \item Sumatra (54.5 mg)
  \item Decaf espresso roast (3 mg)
\end{enumerate}

Table \@ref(tab:cfdesign) shows the final design.

```{r cfdesign, echo=FALSE}
# kable-------------------------------
latin %>% 
  transmute(
    Water = case_when(
      row == 1 ~ "0 ml",
      row == 2 ~ "100 ml",
      row == 3 ~ "200 ml",
      row == 4 ~ "300 ml"
    ),
    speed = case_when(
      col == 1 ~ "<=5",
      col == 2 ~ "5-15",
      col == 3 ~ "15-30",
      col == 4 ~ "30<"
    ),
    coffee = case_when(
      trt == "A" ~ "H(74.5)",
      trt == "B" ~ "W(0)",
      trt == "C" ~ "S(54.5)",
      trt == "D" ~ "D(3)"
    )
  ) %>% 
  group_by(Water) %>% 
  pivot_wider(names_from = speed, values_from = coffee) %>% 
  kable(
    format = kable_format,
    escape = FALSE,
    caption = "Design of the Experiment"
  ) %>% 
  kable_styling(full_width = FALSE, latex_options = c("striped", "HOLD_position")) %>% 
  add_header_above(
    header = c(" " = 1, "Drinking Speed" = 4),
    escape = FALSE
  ) %>% 
  footnote(
    number = c(
      "'Water' is the coffee-to-water ratio (divide with 40 ml)",
      "Numbers in the brackets indicate caffeine (in mg)"
    )
  )
```

We try to control the other variables as possible as we can. When taking coffee,

- Drink coffee every morning (between 8:30 a.m. and 9:00 a.m.)
- after eating a piece of bread
- Nespresso machine: [Pixie C61](https://www.nespresso.com/kr/en/order/machines/original/pixie-electric-red-coffee-machine) in my home

When measuring heart rate,

- Sitting at the table
- Rest my arms on the table
- Use the same strip
    - [Nike sport band](https://www.apple.com/shop/product/MX8C2AM/A/40mm-anthracite-black-nike-sport-band-regular?fnode=5e9ad1340eb02decfee1689be9360555f2f276ad270a672413266cfba01ad7b0e20a1c634dbd66eaec20c01170cf533573070d71c910b376e339037f157174b7e6f45e144d64e052e5274d1069eb67b4)
    - of same fit (8-th)
- and other instructions in [https://support.apple.com/en-us/HT208955](https://support.apple.com/en-us/HT208955)

# Data Analysis {#analysis}

## Data

See Table \@ref(tab:diffdata) for the result of the experiment.

```{r readdata, message=FALSE, echo=FALSE}
# Import---------------------------------
ecg <- read_csv("../data/raw/ecg.csv")
ecg_diff <- read_csv("../data/processed/ecg-diff.csv")
```

```{r diffdata, echo=FALSE}
# Print----------------------------------
ecg_diff %>% 
  select(-id, -date) %>% 
  mutate(
    water = case_when(
      water == 1 ~ "0 ml",
      water == 2 ~ "100 ml",
      water == 3 ~ "200 ml",
      water == 4 ~ "300 ml"
    ),
    speed = case_when(
      speed == 1 ~ "<=5",
      speed == 2 ~ "5-15",
      speed == 3 ~ "15-30",
      speed == 4 ~ "30<"
    ),
    coffee = case_when(
      coffee == 1 ~ "HB",
      coffee == 2 ~ "S",
      coffee == 3 ~ "D",
      coffee == 4 ~ "W"
    )
  ) %>% 
  mutate(
    diff = cell_spec(
      diff, 
      color = spec_color(diff, end = .9, direction = -1),
      font_size = spec_font_size(diff, begin = 8)
    )
  ) %>% 
  unite(coffee, diff, col = "output", sep = ", ") %>% 
  group_by(water) %>% 
  pivot_wider(names_from = speed, values_from = output) %>% 
  kable(
    format = kable_format,
    escape = FALSE,
    caption = "Experiment Data"
  ) %>% 
  kable_styling(full_width = FALSE, latex_options = c("striped", "HOLD_position")) %>% 
  add_header_above(
    header = c(" " = 1, "Drinking Speed" = 4),
    escape = FALSE
  ) %>% 
  footnote(
    number = c(
      "Caffeine: HB > S > D > W",
      "Numbers indicate the difference after and before taking coffee"
    )
  )
```

## ANOVA

Now we build ANOVA table. See \@ref(tab:ecganova).

```{r doanova, include=FALSE}
# ANOVA-------------------------------------
ecg_anova <- aov_lsd(
  diff ~ water + speed + coffee, 
  data = ecg_diff
)
ecg_aov <- broom::tidy(ecg_anova)
```

```{r ecganova, echo=FALSE}
# Print ANOVA-------------------------------
print_anova(ecg_aov, format = kable_format, caption = "ANOVA Table") %>% 
  row_spec(3, color = "red")
```

Recall that only $F_{Tre} = `r ecg_aov$statistic[3]`$ has causal meaning. Now we randomize $F_{Tre}$ under sharp null.

## Randomization Test

### Sharp Null of No Effect

Consider the sharp null of no effect.

\begin{equation}
  H_0: y_{rc}(1) = y_{rc}(2) = y_{rc}(3) = y_{rc}(4)
  (\#eq:sharpnoeff)
\end{equation}

See Science Table in \@ref(tab:posharp).

```{r posharp, message=FALSE, echo=FALSE}
# science table-----------------------------------------------------------
ecg_po <- read_csv("../data/processed/science.csv")
ecg_po %>% 
  # slice(1:4, 13:16) %>%
  kable(
    format = kable_format,
    escape = FALSE,
    caption = "Observed Values of the Science Table for the Coffee-ECG Experiment (row 2 and 3 omitted)"
  ) %>% 
  kable_styling(full_width = FALSE, latex_options = c("striped", "HOLD_position")) %>% 
  add_header_above(
    header = c(" " = 4, "Observed $y_{rc}(k)$" = 4),
    escape = FALSE
  ) %>% 
  pack_rows(
    "Row 1 (Water 0 ml)",
    1, 4
  ) %>% 
  pack_rows(
    "Row 2 (Water 100 ml)",
    5, 8
  ) %>% 
  pack_rows(
    "Row 3 (Water 200 ml)",
    9, 12
  ) %>% 
  pack_rows(
    "Row 4 (Water 300 ml)",
    13, 16
  )
```

Now we impute impute the missing $Y_{rc}(k)$ under the sharp null. See Table \@ref(tab:tablesharp).

```{r tablesharp, message=FALSE, echo=FALSE}
# imputing-------------------------------------------------------------------
ecg_sharp <- read_csv("../data/processed/science-sharp.csv")
ecg_sharp %>% 
  # slice(1:4, 13:16) %>%
  kable(
    format = kable_format,
    escape = FALSE,
    caption = "Imputed Outcomes under the Sharp Null",
    longtable = TRUE
  ) %>% 
  kable_styling(full_width = FALSE, latex_options = c("striped", "HOLD_position")) %>% 
  add_header_above(
    header = c(" " = 4, "Observed $y_{rc}(k)$" = 4),
    escape = FALSE
  ) %>% 
  pack_rows(
    "Row 1 (Water 0 ml)",
    1, 4
  ) %>% 
  pack_rows(
    "Row 2 (Water 100 ml)",
    5, 8
  ) %>% 
  pack_rows(
    "Row 3 (Water 200 ml)",
    9, 12
  ) %>% 
  pack_rows(
    "Row 4 (Water 300 ml)",
    13, 16
  )
```

### Randomization Test

```{r testsharp, echo=FALSE, cache=TRUE}
# randomization test---------------------------------------------
num_iter <- 2000
f_tre <- test_sharp(ecg_sharp, ecg_diff$diff, num_iter, 4, c("water", "speed", "coffee"), 8)
p_val <- sum(f_tre >= ecg_aov$statistic[3]) / num_iter
```

Iterating `r num_iter` times, p-value is

$$pvalue = `r p_val`$$

It is not significant as in ANOVA table (p-value of $`r ecg_aov$p.value[3]`$). Figure \@ref(fig:randsharp) presents the randomization distribution.

```{r randsharp, echo=FALSE, fig.cap="Randomization Distribution of $F_{Tre}$ under the Null"}
# randomization distribution-------------------------------------
tibble(f_stat = f_tre) %>% 
  ggplot(aes(x = f_stat)) +
  geom_histogram(binwidth = .1) +
  geom_vline(xintercept = ecg_aov$statistic[3], col = I("red")) +
  theme_minimal() +
  labs(
    x = element_blank(),
    y = "Frequency"
  )
```

# Conclusion {#conclude}

## Conclusion

We expected that caffeine effect was significant.
However, there was *no significant evidence* (p-value of `r p_val`). Why?

- Caffeine **tolerance**
    - I have taken coffee everyday
    - Was coffee I have taken too small?
- **Outliers**
    - Unit `8` seems outliers
    - Table \@ref(tab:diffdata): value of `r ecg_diff$diff[8]`

## Future Study

```{r toysharp, include=FALSE, cache=TRUE}
# Toy------------------------------------
new_val <- 7
ecg_hb <- 
  ecg_diff %>% 
  mutate(diff = replace(diff, water == 2 & speed == 4 & coffee == 1, new_val))
sharp_hb <- 
  ecg_sharp %>% 
  mutate_at(vars(HB, W, S, De), ~replace(., water == 2 & speed == 4 & coffee == 1, new_val))
# anova with changed value----------------
hb_anova <- aov_lsd(
  diff ~ water + speed + coffee,
  data = ecg_hb
)
hb_aov <- broom::tidy(hb_anova)
# randomization with changed value--------
hb_tre <- test_sharp(sharp_hb, ecg_hb$diff, num_iter, 4, c("water", "speed", "coffee"), 8)
hb_pval <- sum(hb_tre >= hb_aov$statistic[3]) / num_iter
```

- Values for the treatment were quite arbitrary, so we can re-try with other sets
- Re-measure (for Unit `8`)
    - Figure \@ref(fig:hbsharp): Change the value of Unit `8` to `r new_val`
    - P-value becomes `r hb_pval`

```{r hbsharp, echo=FALSE, fig.cap="Changing the Outlier"}
tibble(f_stat = hb_tre) %>% 
  ggplot(aes(x = f_stat)) +
  geom_histogram(binwidth = .1) +
  geom_vline(xintercept = hb_aov$statistic[3], col = I("red")) +
  theme_minimal() +
  labs(
    x = element_blank(),
    y = "Frequency"
  )
```

\newpage

<!-- reference here -->

# References {-}

<div id="refs"></div>

\newpage

# (APPENDIX) Appendix {-}

# Appendix

## Codes

```{r get-labels, include=FALSE}
lbs <- knitr::all_labels()
lbs <- setdiff(lbs, c("setup", "get-labels", "pkgs", "allocation"))
lbs_design <- str_subset(lbs, pattern = "design$")
lbs_data <- str_subset(lbs, "data$")
lbs_anova <- str_subset(lbs, pattern = "anova$")
lbs_sharp <- str_subset(lbs, "sharp$")
```

Package loading:

```{r ref.label="pkgs", echo=TRUE, eval=FALSE}
```

Design:

```{r ref.label=lbs_design, echo=TRUE, eval=FALSE}
```

Data:

```{r ref.label=lbs_anova, echo=TRUE, eval=FALSE}
```

ANOVA:

```{r ref.label=lbs_anova, echo=TRUE, eval=FALSE}
```

Randomization:

```{r ref.label=lbs_sharp, echo=TRUE, eval=FALSE}
```


\newpage

## ECG Results

```{r, include=FALSE}
fig_subcap <- c(
  "(1,1),House blend", "(1,2),Water", "(1,3),Sumatra", "(1,4),Decaf",
  "(2,1),Water", "(2,2),Sumatra", "(2,3),Decaf", "(2,4),House blend",
  "(3,1),Sumatra", "(3,2),Decaf", "(3,3),House blend", "(3,4),Water",
  "(4,1),Decaf", "(4,2),House blend", "(4,3),Water", "(4,4),Sumatra"
)
fig_subcap <- str_c(fig_subcap, str_c(ecg$post, " BPM"), sep = ": ")
```


```{r resplot, echo=FALSE, fig.cap="Electrocardiogram after drinking Coffee", fig.subcap = fig_subcap, fig.asp=1, fig.ncol = 4, out.width="25%"}
# (1, 1)----------------------------------------------------
knitr::include_graphics("../docs/images/ecg-2021-04-22.pdf")
# (1, 2)----------------------------------------------------
knitr::include_graphics("../docs/images/ecg-2021-04-23.pdf")
# (1, 3)----------------------------------------------------
knitr::include_graphics("../docs/images/ecg-2021-04-24.pdf")
# (1, 4)----------------------------------------------------
knitr::include_graphics("../docs/images/ecg-2021-04-25.pdf")
# (2, 1)----------------------------------------------------
knitr::include_graphics("../docs/images/ecg-2021-04-26.pdf")
# (2, 2)----------------------------------------------------
knitr::include_graphics("../docs/images/ecg-2021-04-27.pdf")
# (2, 3)----------------------------------------------------
knitr::include_graphics("../docs/images/ecg-2021-04-28.pdf")
# (2, 3)----------------------------------------------------
knitr::include_graphics("../docs/images/ecg-2021-04-29.pdf")
# (3, 1)----------------------------------------------------
knitr::include_graphics("../docs/images/ecg-2021-04-30.pdf")
# (3, 2)----------------------------------------------------
knitr::include_graphics("../docs/images/ecg-2021-05-01.pdf")
# (3, 3)----------------------------------------------------
knitr::include_graphics("../docs/images/ecg-2021-05-02.pdf")
# (3, 4)----------------------------------------------------
knitr::include_graphics("../docs/images/ecg-2021-05-03.pdf")
# (4, 1)----------------------------------------------------
knitr::include_graphics("../docs/images/ecg-2021-05-04.pdf")
# (4, 2)----------------------------------------------------
knitr::include_graphics("../docs/images/ecg-2021-05-05.pdf")
# (4, 3)----------------------------------------------------
knitr::include_graphics("../docs/images/ecg-2021-05-06.pdf")
# (4, 4)----------------------------------------------------
knitr::include_graphics("../docs/images/ecg-2021-05-07.pdf")
```







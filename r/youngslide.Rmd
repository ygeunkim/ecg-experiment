---
title: "Electrocardiogram Experiment"
subtitle: "using latin square design"
author: |
  | Young Geun Kim
  | [ygeunkim.github.io](https://ygeunkim.github.io)
institute: "2019711358, [Department of Statistics](https://stat.skku.edu/stat/index.jsp)"
date: "`r format(Sys.time(), '%d %b, %Y')`"
bibliography: "../docs/ecgref.bib"
biblio-style: "apalike"
link-citations: yes
# nocite: "sta5031"
output:
  bookdown::beamer_presentation2:
    toc: yes
    slide_level: 2
    theme: "Darmstadt"
    colortheme: "beaver"
    fonttheme: "professionalfonts"
    citation_package: natbib
    includes:
      in_header: "../docs/preamble.tex"
knit:
  (function(inputFile, encoding) {
    rmarkdown::render(input = inputFile, encoding = encoding, output_dir = "../static/slides")
  })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  out.width = "70%",
  fig.align = "center",
  fig.width = 6,
  fig.pos = "H",
  fig.asp = .618
  )
knitr::knit_hooks$set(
  document = function(x) {
    sub("\\usepackage[]{color}", "\\usepackage{xcolor}", x, fixed = TRUE)
  }
)
options(digits = 3)
options(knitr.kable.NA = "")
options(kableExtra.latex.load_packages = FALSE)
is_html <- knitr::opts_knit$get("rmarkdown.pandoc.to") == "html"
is_latex <- knitr::opts_knit$get("rmarkdown.pandoc.to") == "latex"
is_beamer <- knitr::opts_knit$get("rmarkdown.pandoc.to") == "beamer"
kable_format <- ifelse(!is_html, "latex", "html")
kable_format <- ifelse(length(kable_format) == 0, "html", kable_format) # for excecutable
```

```{r pkgs, message=FALSE, echo=FALSE}
# tidyverse family---------------------
library(tidyverse)
# kable--------------------------------
library(knitr)
library(kableExtra)
# LSD randomization--------------------
library(magic)
# set seed for report -----------------
set.seed(1)
```

```{r fns, message=FALSE, echo=FALSE}
source("lsd-anova.R")
source("lsd-rand.R")
```


# Introduction

## Electrocardiogram Experiment

::: columns

:::: column
### Goal

- Does caffeine affect ECG or *heart rate*?
- Caffeine: *coffee*
- Output: Average heart rate (BPM)

::::

:::: column

```{r ecgimage, echo=FALSE}
knitr::include_graphics("../docs/images/ecg-support.jpg")
```

::::

:::

## Latin Square Design

```{r, include=FALSE}
latin <- 
  tibble(
    row = rep(1:4, each = 4),
    col = rep(1:4, 4),
    trt = c(LETTERS[1:4], c("B", "C", "D", "A"), c("C", "D", "A", "B"), c("D", "A", "B", "A"))
  )
```

```{r latindesign, echo=FALSE}
latin %>% 
  group_by(row) %>% 
  pivot_wider(names_from = col, values_from = trt) %>% 
  kable(
    format = kable_format,
    escape = FALSE,
    caption = "Reduced Latin Square",
    col.names = c("Row", 1:4)
  ) %>% 
  kable_styling(full_width = FALSE, latex_options = c("striped", "HOLD_position")) %>% 
  add_header_above(
    header = c(" " = 1, "Column " = 4),
    escape = FALSE
  )
```

- Each treatment once in each row and column
- We allocate 4 treatment levels randomly

<!-- details of the design -->

# Design and the Data

## Blocking Factors

Caffeine intake depends on the following two factors [@naver2018].

::: columns

:::: column

### Row: Coffee-to-water ratio

1. 1:0 (Espresso, 40 ml)
2. 1:2.5 (Water 100 ml)
3. 1:5 (Water 200 ml)
4. 1:7.5 (Water 300 ml)

### Column: Drinking speed

1. <=5 sec
2. 5-15 sec
3. 15-30 sec
4. 30< sec
::::

:::: column

```{r espresso, echo=FALSE}
knitr::include_graphics("../docs/images/espresso.png")
```

::::

:::

## Factor

Intake of caffeine [@reddit2020] from [Starbucks by Nespresso](https://athome.starbucks.com/coffees-by-format/nespresso-original/)

1. House blend: 74.5 mg
2. Sumatra: 54.5 mg
3. Decaf espresso roast: 3 mg
4. Just water: 0 mg

## Output

::: columns

:::: column
### Value: Average heart rate

- in BPM
- Notations from the course [@sta5031]
- Since there exists variation, we consider difference of BPM after and before: $y_{rc}^{post} - y_{rc}^{pre}$

### Measure

- Apple Watch Series 4
- [ECG app](https://support.apple.com/en-us/HT208955)
- Algorithm version: 1

::::

:::: column

```{r watchimage, echo=FALSE}
knitr::include_graphics("../docs/images/ecg-support-watch.jpg")
```

::::

:::

<!-- Design -->

## Randomized Assignment

1. Randomly allocate (`1`, `2`, `3`, `4`) to previous (`A`, `B`, `C`, `D`)
2. Assign to above Table \@ref(tab:latindesign)

```{r}
set.seed(1)
sample(LETTERS[1:4])
```

\begin{enumerate}[(A)]
  \item House blend (74.5 mg)
  \item Water (0 mg)
  \item Sumatra (54.5 mg)
  \item Decaf espresso roast (3 mg)
\end{enumerate}

## Latin Square

```{r cfdesign, echo=FALSE}
latin %>% 
  transmute(
    Water = case_when(
      row == 1 ~ "0 ml",
      row == 2 ~ "100 ml",
      row == 3 ~ "200 ml",
      row == 4 ~ "300 ml"
    ),
    speed = case_when(
      col == 1 ~ "<=5",
      col == 2 ~ "5-15",
      col == 3 ~ "15-30",
      col == 4 ~ "30<"
    ),
    coffee = case_when(
      trt == "A" ~ "H(74.5)",
      trt == "B" ~ "W(0)",
      trt == "C" ~ "S(54.5)",
      trt == "D" ~ "D(3)"
    )
  ) %>% 
  group_by(Water) %>% 
  pivot_wider(names_from = speed, values_from = coffee) %>% 
  kable(
    format = kable_format,
    escape = FALSE,
    caption = "Design of the Experiment"
  ) %>% 
  kable_styling(full_width = FALSE, latex_options = c("striped", "HOLD_position")) %>% 
  add_header_above(
    header = c(" " = 1, "Drinking Speed" = 4),
    escape = FALSE
  ) %>% 
  footnote(
    number = c(
      "'Water' is the coffee-to-water ratio (divide with 40 ml)",
      "Numbers in the brackets indicate caffeine (in mg)"
    )
  )
```

- Use *reduced latin square*
- Randomization test afterward

## Controlling the Other Variables

### Coffee

- Drink coffee every morning (between 8:30 a.m. and 9:00 a.m.)
- after eating a piece of bread
- Nespresso machine: [Pixie C61](https://www.nespresso.com/kr/en/order/machines/original/pixie-electric-red-coffee-machine) in my home

### Measure

- Sitting at the table
- Rest my arms on the table
- Use the same strip
    - [Nike sport band](https://www.apple.com/shop/product/MX8C2AM/A/40mm-anthracite-black-nike-sport-band-regular?fnode=5e9ad1340eb02decfee1689be9360555f2f276ad270a672413266cfba01ad7b0e20a1c634dbd66eaec20c01170cf533573070d71c910b376e339037f157174b7e6f45e144d64e052e5274d1069eb67b4)
    - of same fit (8-th)
- and other instructions in [https://support.apple.com/en-us/HT208955](https://support.apple.com/en-us/HT208955)

<!-- analysis -->

# Analysis

## Dataset

```{r, message=FALSE, echo=FALSE}
ecg <- read_csv("../data/raw/ecg.csv")
ecg_diff <- read_csv("../data/processed/ecg-diff.csv")
```

```{r diffdata, echo=FALSE}
ecg_diff %>% 
  select(-id, -date) %>% 
  mutate(
    water = case_when(
      water == 1 ~ "0 ml",
      water == 2 ~ "100 ml",
      water == 3 ~ "200 ml",
      water == 4 ~ "300 ml"
    ),
    speed = case_when(
      speed == 1 ~ "<=5",
      speed == 2 ~ "5-15",
      speed == 3 ~ "15-30",
      speed == 4 ~ "30<"
    ),
    coffee = case_when(
      coffee == 1 ~ "HB",
      coffee == 2 ~ "S",
      coffee == 3 ~ "D",
      coffee == 4 ~ "W"
    )
  ) %>% 
  mutate(
    diff = cell_spec(
      diff, 
      color = spec_color(diff, end = .9, direction = -1),
      font_size = spec_font_size(diff, begin = 8)
    )
  ) %>% 
  unite(coffee, diff, col = "output", sep = ", ") %>% 
  group_by(water) %>% 
  pivot_wider(names_from = speed, values_from = output) %>% 
  kable(
    format = kable_format,
    escape = FALSE,
    caption = "Experiment Data"
  ) %>% 
  kable_styling(full_width = FALSE, latex_options = c("striped", "HOLD_position")) %>% 
  add_header_above(
    header = c(" " = 1, "Drinking Speed" = 4),
    escape = FALSE
  ) %>% 
  footnote(
    number = c(
      "Caffeine: HB > S > D > W",
      "Numbers indicate the difference after and before taking coffee"
    )
  )
```


## ANOVA

```{r, include=FALSE}
ecg_anova <- aov_lsd(
  diff ~ water + speed + coffee, 
  data = ecg_diff
)
ecg_aov <- broom::tidy(ecg_anova)
```

```{r ecganova, echo=FALSE}
print_anova(ecg_aov, format = kable_format, caption = "ANOVA Table") %>% 
  row_spec(3, color = "red")
```

- ANOVA table from the observed data
- $F_{Tre} = `r ecg_aov$statistic[3]`$: has causal meaning
- Randomize $F_{Tre}$ under sharp null


## Sharp Null

::: columns

:::: column
### Sharp null hypothesis

- of **no effect**
- \textcolor{blue}{$H_0: y_{rc}(1) = y_{rc}(2) = y_{rc}(3) = y_{rc}(4)$}
- for all $r, c$

### Imputing

1. Under the sharp null, impute the missing $Y_{rc}(k)$
2. Apply the formulation (SSRow, SSCol, SSTre, SSRes, SSTot)

::::

:::: column

```{r potable, message=FALSE, echo=FALSE}
ecg_po <- read_csv("../data/processed/science.csv")
ecg_po %>% 
  slice(1:4, 13:16) %>%
  kable(
    format = kable_format,
    escape = FALSE,
    caption = "Observed Values of the Science Table for the Coffee-ECG Experiment"
  ) %>% 
  kable_styling(full_width = FALSE, latex_options = c("striped", "HOLD_position", "scale_down")) %>% 
  add_header_above(
    header = c(" " = 4, "Observed $y_{rc}(k)$" = 4),
    escape = FALSE
  ) %>% 
  pack_rows(
    "Row 1 (Water 0 ml)",
    1, 4
  ) %>% 
  pack_rows(
    "Row 4 (Water 300 ml)",
    5, 8
  )
```

::::

:::


## Imputation of Observed Potential Outcomes

Under the sharp null,

```{r sharptable, message=FALSE, echo=FALSE}
ecg_sharp <- read_csv("../data/processed/science-sharp.csv")
ecg_sharp %>% 
  slice(1:4, 13:16) %>%
  kable(
    format = kable_format,
    escape = FALSE,
    caption = "Imputed Outcomes under the Sharp Null",
    longtable = TRUE
  ) %>% 
  kable_styling(full_width = FALSE, latex_options = c("striped", "HOLD_position")) %>% 
  add_header_above(
    header = c(" " = 4, "Observed $y_{rc}(k)$" = 4),
    escape = FALSE
  ) %>% 
  pack_rows(
    "Row 1 (Water 0 ml)",
    1, 4
  ) %>% 
  pack_rows(
    "Row 4 (Water 300 ml)",
    5, 8
  )
```


## Randomization Test

<!-- references -->

# Related Contents

## Project Repo {-}

My Github project for this experiment:

[https://github.com/ygeunkim/ecg-experiment](https://github.com/ygeunkim/ecg-experiment)

<div id="refs"></div>

